{% extends 'base.html' %}

{% block title %}Withdrawal Status - Secure Marketplace{% endblock %}

{% block extra_head %}
<style>
    .withdrawal-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    .status-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    .status-header {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .status-body {
        padding: 20px;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        text-transform: uppercase;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .status-completed { background: #d1ecf1; color: #0c5460; }
    .status-cancelled { background: #f1f3f4; color: #495057; }
    .withdrawal-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .detail-label {
        font-weight: bold;
        color: #495057;
        margin-bottom: 5px;
    }
    .detail-value {
        color: #212529;
        word-break: break-all;
    }
    .timeline {
        margin-top: 20px;
    }
    .timeline-item {
        display: flex;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f1f1f1;
    }
    .timeline-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .timeline-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.2em;
        flex-shrink: 0;
    }
    .timeline-content {
        flex: 1;
    }
    .timeline-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .timeline-description {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    .timeline-time {
        color: #999;
        font-size: 0.8em;
    }
    .icon-pending { background: #fff3cd; color: #856404; }
    .icon-approved { background: #d4edda; color: #155724; }
    .icon-rejected { background: #f8d7da; color: #721c24; }
    .icon-completed { background: #d1ecf1; color: #0c5460; }
    .risk-info {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
    }
    .risk-high {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    .action-buttons {
        margin-top: 20px;
        text-align: center;
    }
    .btn {
        display: inline-block;
        padding: 10px 20px;
        margin: 0 5px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        cursor: pointer;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn:hover { opacity: 0.9; text-decoration: none; color: white; }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    .empty-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="withdrawal-container">
    <h1>üì§ Withdrawal Status</h1>
    
    {% if withdrawal_requests %}
        {% for request in withdrawal_requests %}
        <div class="status-card">
            <div class="status-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Withdrawal Request #{{ request.id }}</h3>
                    <span class="status-badge status-{{ request.status }}">{{ request.get_status_display }}</span>
                </div>
            </div>
            
            <div class="status-body">
                <div class="withdrawal-details">
                    <div class="detail-item">
                        <div class="detail-label">Amount</div>
                        <div class="detail-value">{{ request.amount|floatformat:8 }} {{ request.currency|upper }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Destination Address</div>
                        <div class="detail-value">{{ request.address }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Network Fee</div>
                        <div class="detail-value">{{ request.network_fee|floatformat:8 }} {{ request.currency|upper }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Requested</div>
                        <div class="detail-value">{{ request.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                </div>
                
                {% if request.risk_score > 0 %}
                <div class="risk-info {% if request.risk_score > 70 %}risk-high{% endif %}">
                    <strong>üîç Risk Assessment:</strong> {{ request.risk_score }}/100
                    {% if request.risk_factors %}
                    <br><strong>Factors:</strong> {{ request.risk_factors|join:", " }}
                    {% endif %}
                    {% if request.manual_review_required %}
                    <br><strong>‚ö†Ô∏è Manual Review Required:</strong> This withdrawal requires admin approval due to security policies.
                    {% endif %}
                </div>
                {% endif %}
                
                {% if request.admin_notes %}
                <div class="risk-info">
                    <strong>üìù Admin Notes:</strong> {{ request.admin_notes }}
                </div>
                {% endif %}
                
                <div class="timeline">
                    <h4>üìã Processing Timeline</h4>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon icon-completed">üìù</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Withdrawal Requested</div>
                            <div class="timeline-description">Request submitted and validated</div>
                            <div class="timeline-time">{{ request.created_at|date:"M d, Y H:i" }}</div>
                        </div>
                    </div>
                    
                    {% if request.status != 'pending' %}
                    <div class="timeline-item">
                        <div class="timeline-icon {% if request.status == 'approved' %}icon-approved{% elif request.status == 'rejected' %}icon-rejected{% elif request.status == 'completed' %}icon-completed{% else %}icon-pending{% endif %}">
                            {% if request.status == 'approved' %}‚úÖ
                            {% elif request.status == 'rejected' %}‚ùå
                            {% elif request.status == 'completed' %}üéâ
                            {% else %}‚è≥{% endif %}
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">
                                {% if request.status == 'approved' %}Admin Approved
                                {% elif request.status == 'rejected' %}Request Rejected
                                {% elif request.status == 'completed' %}Transaction Completed
                                {% elif request.status == 'cancelled' %}Request Cancelled
                                {% else %}{{ request.get_status_display }}{% endif %}
                            </div>
                            <div class="timeline-description">
                                {% if request.status == 'approved' %}Withdrawal approved by admin and queued for processing
                                {% elif request.status == 'rejected' %}Request was rejected by admin review
                                {% elif request.status == 'completed' %}Funds successfully sent to destination address
                                {% elif request.status == 'cancelled' %}Request was cancelled
                                {% else %}Status updated{% endif %}
                            </div>
                            {% if request.processed_at %}
                            <div class="timeline-time">{{ request.processed_at|date:"M d, Y H:i" }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if request.transaction_hash %}
                    <div class="timeline-item">
                        <div class="timeline-icon icon-completed">üîó</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Transaction Broadcast</div>
                            <div class="timeline-description">
                                Transaction hash: <code>{{ request.transaction_hash }}</code>
                            </div>
                            {% if request.processed_at %}
                            <div class="timeline-time">{{ request.processed_at|date:"M d, Y H:i" }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="action-buttons">
                    {% if request.status == 'pending' %}
                    <form method="post" action="{% url 'wallets:cancel_withdrawal' request.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this withdrawal request?')">
                            Cancel Request
                        </button>
                    </form>
                    {% endif %}
                    
                    <a href="{% url 'wallets:withdrawal_detail' request.id %}" class="btn btn-secondary">
                        View Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="{% url 'wallets:withdraw' %}" class="btn btn-primary">New Withdrawal Request</a>
            <a href="{% url 'wallets:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
        
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">üì§</div>
            <h3>No Withdrawal Requests</h3>
            <p>You haven't made any withdrawal requests yet.</p>
            <a href="{% url 'wallets:withdraw' %}" class="btn btn-primary">Make Your First Withdrawal</a>
        </div>
    {% endif %}
</div>
{% endblock %}
