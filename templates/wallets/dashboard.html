{% extends "base_tor_safe.html" %}

{% block title %}Wallet Dashboard - Secure Marketplace{% endblock %}

{% block extra_head %}
<style>
    .wallet-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .balance-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .balance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .balance-item {
        text-align: center;
        padding: 15px;
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
    .balance-amount {
        font-size: 1.8em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .balance-label {
        font-size: 0.9em;
        opacity: 0.8;
    }
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .action-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease;
    }
    .action-card:hover {
        transform: translateY(-5px);
    }
    .action-icon {
        font-size: 3em;
        margin-bottom: 15px;
        display: block;
    }
    .action-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }
    .action-description {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
    }
    .btn-action {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
        transition: background 0.3s ease;
    }
    .btn-action:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }
    .security-status {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .security-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .security-icon {
        margin-right: 10px;
        font-size: 1.2em;
    }
    .status-enabled { color: #28a745; }
    .status-disabled { color: #dc3545; }
    .status-warning { color: #ffc107; }
    .recent-activity {
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .activity-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
    }
    .activity-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .activity-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .activity-item:last-child {
        border-bottom: none;
    }
    .activity-info {
        flex: 1;
    }
    .activity-type {
        font-weight: bold;
        color: #333;
    }
    .activity-details {
        color: #666;
        font-size: 0.9em;
        margin-top: 2px;
    }
    .activity-amount {
        font-weight: bold;
        font-size: 1.1em;
    }
    .amount-positive { color: #28a745; }
    .amount-negative { color: #dc3545; }
    .amount-neutral { color: #6c757d; }
    .risk-assessment {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .risk-high {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    .withdrawal-limits {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    .limit-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .limit-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .security-alerts {
        background: #f8f9fa;
        border-left: 4px solid #dc3545;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 0 5px 5px 0;
    }
    .alert-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
        border-left: 3px solid #dc3545;
    }
    .alert-item:last-child {
        margin-bottom: 0;
    }
    .two-factor-setup {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="wallet-container">
    <h1>üí∞ Comprehensive Wallet Dashboard</h1>
    
    <!-- Security Alerts -->
    {% if security_alerts %}
    <div class="security-alerts">
        <h3>üö® Security Alerts</h3>
        {% for alert in security_alerts %}
        <div class="alert-item">
            <strong>{{ alert.get_severity_display }}</strong>: {{ alert.title }}
            <br><small>{{ alert.created_at|date:"M d, Y H:i" }}</small>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Balance Overview -->
    <div class="balance-card">
        <h2>üíé Your Balances</h2>
        <div class="balance-grid">
            <div class="balance-item">
                <div class="balance-amount">{{ wallet.btc_balance|floatformat:8 }}</div>
                <div class="balance-label">BTC Available</div>
            </div>
            <div class="balance-item">
                <div class="balance-amount">{{ wallet.xmr_balance|floatformat:12 }}</div>
                <div class="balance-label">XMR Available</div>
            </div>
            <div class="balance-item">
                <div class="balance-amount">{{ wallet.btc_escrow_balance|floatformat:8 }}</div>
                <div class="balance-label">BTC in Escrow</div>
            </div>
            <div class="balance-item">
                <div class="balance-amount">{{ wallet.xmr_escrow_balance|floatformat:12 }}</div>
                <div class="balance-label">XMR in Escrow</div>
            </div>
        </div>
    </div>
    
    <!-- Withdrawal Limits -->
    <div class="withdrawal-limits">
        <h3>üí≥ Withdrawal Limits</h3>
        <div class="limit-item">
            <span>Daily BTC Limit:</span>
            <span>{{ wallet.daily_withdrawal_limit_btc|floatformat:8 }} BTC</span>
        </div>
        <div class="limit-item">
            <span>Daily XMR Limit:</span>
            <span>{{ wallet.daily_withdrawal_limit_xmr|floatformat:12 }} XMR</span>
        </div>
        <div class="limit-item">
            <span>Account Age:</span>
            <span>{{ user.date_joined|timesince }} old</span>
        </div>
    </div>
    
    <!-- Two-Factor Authentication Setup -->
    {% if not wallet.two_factor_enabled %}
    <div class="two-factor-setup">
        <h3>üîê Enhance Your Security</h3>
        <p>Enable Two-Factor Authentication for additional protection of your funds.</p>
        <a href="{% url 'wallets:security_settings' %}" class="btn-action">Setup 2FA</a>
    </div>
    {% endif %}
    
    <!-- Quick Actions -->
    <div class="action-grid">
        <div class="action-card">
            <span class="action-icon">üì•</span>
            <div class="action-title">Deposit Funds</div>
            <div class="action-description">
                Add Bitcoin or Monero to your wallet using our secure deposit system with privacy protection.
            </div>
            <a href="{% url 'wallets:deposit' %}" class="btn-action">Deposit</a>
        </div>
        
        <div class="action-card">
            <span class="action-icon">üì§</span>
            <div class="action-title">Withdraw Funds</div>
            <div class="action-description">
                Send cryptocurrency to external wallets with enhanced security and manual admin approval.
            </div>
            <a href="{% url 'wallets:withdraw' %}" class="btn-action">Withdraw</a>
        </div>
        
        <div class="action-card">
            <span class="action-icon">üîÑ</span>
            <div class="action-title">Convert Currency</div>
            <div class="action-description">
                Exchange between Bitcoin and Monero at current market rates with transparent fees.
            </div>
            <a href="{% url 'wallets:convert' %}" class="btn-action">Convert</a>
        </div>
        
        <div class="action-card">
            <span class="action-icon">üìä</span>
            <div class="action-title">Transaction History</div>
            <div class="action-description">
                View detailed history of all wallet transactions with comprehensive audit trail.
            </div>
            <a href="{% url 'wallets:transactions' %}" class="btn-action">View History</a>
        </div>
        
        <div class="action-card">
            <span class="action-icon">üõ°Ô∏è</span>
            <div class="action-title">Security Settings</div>
            <div class="action-description">
                Configure two-factor authentication, withdrawal PINs, and other security features.
            </div>
            <a href="{% url 'wallets:security_settings' %}" class="btn-action">Security</a>
        </div>
        
        <div class="action-card">
            <span class="action-icon">üìã</span>
            <div class="action-title">Withdrawal Requests</div>
            <div class="action-description">
                Track status of pending withdrawal requests and manual review processes.
            </div>
            <a href="{% url 'wallets:withdrawal_status' %}" class="btn-action">View Requests</a>
        </div>
    </div>
    
    <!-- Security Status -->
    <div class="security-status">
        <h3>üõ°Ô∏è Security Status</h3>
        <div class="security-item">
            <span class="security-icon {% if wallet.two_factor_enabled %}status-enabled{% else %}status-disabled{% endif %}">
                {% if wallet.two_factor_enabled %}‚úÖ{% else %}‚ùå{% endif %}
            </span>
            <span>Two-Factor Authentication: 
                {% if wallet.two_factor_enabled %}Enabled{% else %}Disabled - <a href="{% url 'wallets:security_settings' %}">Enable Now</a>{% endif %}
            </span>
        </div>
        <div class="security-item">
            <span class="security-icon {% if wallet.withdrawal_pin_enabled %}status-enabled{% else %}status-disabled{% endif %}">
                {% if wallet.withdrawal_pin_enabled %}‚úÖ{% else %}‚ùå{% endif %}
            </span>
            <span>Withdrawal PIN: 
                {% if wallet.withdrawal_pin_enabled %}Enabled{% else %}Disabled - <a href="{% url 'wallets:security_settings' %}">Setup PIN</a>{% endif %}
            </span>
        </div>
        <div class="security-item">
            <span class="security-icon status-enabled">‚úÖ</span>
            <span>Tor Network: Active & Protected</span>
        </div>
        <div class="security-item">
            <span class="security-icon status-enabled">‚úÖ</span>
            <span>Privacy Protection: No IP Address Logging</span>
        </div>
        <div class="security-item">
            <span class="security-icon status-enabled">‚úÖ</span>
            <span>Manual Withdrawal Review: Active</span>
        </div>
        <div class="security-item">
            <span class="security-icon{% if wallet.risk_score < 30 %} status-enabled{% elif wallet.risk_score < 70 %} status-warning{% else %} status-disabled{% endif %}">
                {% if wallet.risk_score < 30 %}‚úÖ{% elif wallet.risk_score < 70 %}‚ö†Ô∏è{% else %}‚ùå{% endif %}
            </span>
            <span>Risk Assessment: 
                {% if wallet.risk_score < 30 %}Low Risk ({{ wallet.risk_score }}/100){% elif wallet.risk_score < 70 %}Medium Risk ({{ wallet.risk_score }}/100){% else %}High Risk ({{ wallet.risk_score }}/100){% endif %}
            </span>
        </div>
        {% if wallet.last_security_check %}
        <div class="security-item">
            <span class="security-icon status-enabled">üîç</span>
            <span>Last Security Check: {{ wallet.last_security_check|date:"M d, Y H:i" }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Recent Activity -->
    <div class="recent-activity">
        <div class="activity-header">
            <h3>üìà Recent Activity</h3>
            <small>All transactions are logged for security and audit purposes</small>
        </div>
        <div class="activity-list">
            {% for transaction in recent_transactions %}
            <div class="activity-item">
                <div class="activity-info">
                    <div class="activity-type">
                        {% if transaction.type == 'deposit' %}üì• Deposit
                        {% elif transaction.type == 'withdrawal' %}üì§ Withdrawal
                        {% elif transaction.type == 'conversion' %}üîÑ Conversion
                        {% elif transaction.type == 'escrow_lock' %}üîí Escrow Lock
                        {% elif transaction.type == 'escrow_release' %}üîì Escrow Release
                        {% elif transaction.type == 'escrow_refund' %}‚Ü©Ô∏è Escrow Refund
                        {% elif transaction.type == 'fee' %}üí∏ Fee
                        {% elif transaction.type == 'adjustment' %}‚öñÔ∏è Adjustment
                        {% else %}üí∞ {{ transaction.get_type_display }}
                        {% endif %}
                    </div>
                    <div class="activity-details">
                        {{ transaction.created_at|date:"M d, Y H:i" }} ‚Ä¢ {{ transaction.reference }}
                        {% if transaction.metadata.admin_approved %}‚Ä¢ Admin Approved{% endif %}
                        {% if transaction.metadata.risk_score %}‚Ä¢ Risk: {{ transaction.metadata.risk_score }}{% endif %}
                    </div>
                </div>
                <div class="activity-amount 
                    {% if transaction.type == 'deposit' or transaction.type == 'escrow_release' %}amount-positive
                    {% elif transaction.type == 'withdrawal' or transaction.type == 'escrow_lock' or transaction.type == 'fee' %}amount-negative
                    {% else %}amount-neutral{% endif %}">
                    {% if transaction.type == 'deposit' or transaction.type == 'escrow_release' %}+{% elif transaction.type == 'withdrawal' or transaction.type == 'escrow_lock' or transaction.type == 'fee' %}-{% endif %}{{ transaction.amount|floatformat:8 }} {{ transaction.currency|upper }}
                </div>
            </div>
            {% empty %}
            <div class="activity-item">
                <div class="activity-info">
                    <div class="activity-type">No recent activity</div>
                    <div class="activity-details">Your transaction history will appear here once you start using your wallet</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if recent_transactions %}
        <div style="padding: 15px 20px; text-align: center; border-top: 1px solid #dee2e6;">
            <a href="{% url 'wallets:transactions' %}" class="btn-action">View All Transactions</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
