{% extends "base_tor_safe.html" %}
{% load static %}

{% block title %}Order #{{ order.id|slice:":8" }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card card-elevation-3">
                <div class="card-body p-4">
                    <!-- Order Header -->
                    <div class="order-header mb-4">
                        <h1 class="h2 mb-3">
                            <span class="order-icon">üì¶</span>
                            Order Details
                        </h1>
                        <div class="order-meta">
                            <span class="order-id">Order ID: <strong>{{ order.id|slice:":8" }}</strong></span>
                            <span class="order-status status-{{ order.status|lower }}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>

                    <!-- Order Info Grid -->
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Date:</label>
                            <span>{{ order.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="info-item">
                            <label>Vendor:</label>
                            <span>{{ order.vendor.vendor_name }}</span>
                        </div>
                        <div class="info-item">
                            <label>Total Amount:</label>
                            <span class="amount">
                                {% if order.currency_used == 'BTC' %}
                                    ‚Çø{{ order.total_btc }}
                                {% else %}
                                    XMR {{ order.total_xmr }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="info-item">
                            <label>Currency:</label>
                            <span>{{ order.get_currency_used_display }}</span>
                        </div>
                        {% if order.auto_finalize_at %}
                        <div class="info-item">
                            <label>Auto-finalize:</label>
                            <span>{{ order.auto_finalize_at|date:"Y-m-d H:i" }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Order Items -->
                    <div class="order-items mt-4">
                        <h3 class="h5 mb-3">Order Items</h3>
                        <div class="items-list">
                            {% for item in order_items %}
                            <div class="order-item">
                                <div class="item-name">{{ item.product.name }}</div>
                                <div class="item-details">
                                    <span class="quantity">Qty: {{ item.quantity }}</span>
                                    <span class="price">
                                        {% if order.currency_used == 'BTC' %}
                                            ‚Çø{{ item.price_btc }} each
                                        {% else %}
                                            XMR {{ item.price_xmr }} each
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="order-item">
                                <div class="item-name">{{ order.product.name|default:"Product" }}</div>
                                <div class="item-details">
                                    <span class="quantity">Qty: {{ order.quantity|default:1 }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Status Timeline -->
                    <div class="status-timeline mt-4">
                        <h3 class="h5 mb-3">Order Progress</h3>
                        <div class="timeline">
                            <div class="timeline-item {% if order.created_at %}completed{% endif %}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <strong>Order Created</strong>
                                    {% if order.created_at %}
                                    <span class="timestamp">{{ order.created_at|date:"Y-m-d H:i" }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-item {% if order.locked_at %}completed{% endif %}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <strong>Funds Locked</strong>
                                    {% if order.locked_at %}
                                    <span class="timestamp">{{ order.locked_at|date:"Y-m-d H:i" }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-item {% if order.shipped_at %}completed{% endif %}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <strong>Order Shipped</strong>
                                    {% if order.shipped_at %}
                                    <span class="timestamp">{{ order.shipped_at|date:"Y-m-d H:i" }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-item {% if order.completed_at %}completed{% endif %}">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <strong>Order Completed</strong>
                                    {% if order.completed_at %}
                                    <span class="timestamp">{{ order.completed_at|date:"Y-m-d H:i" }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dispute Info -->
                    {% if order.dispute %}
                    <div class="alert alert-warning mt-4">
                        <h4 class="alert-heading">‚ö†Ô∏è Dispute Active</h4>
                        <p class="mb-2">This order is currently under dispute.</p>
                        <a href="{% url 'disputes:detail' order.dispute.id %}" class="btn btn-sm btn-warning">
                            View Dispute Details
                        </a>
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="order-actions mt-5">
                        <h3 class="h5 mb-3">Available Actions</h3>
                        
                        <div class="actions-grid">
                            <!-- Buyer Actions -->
                            {% if is_buyer %}
                                {% if can_finalize %}
                                <form method="post" action="{% url 'orders:confirm' order.id %}" class="action-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-lg">
                                        ‚úÖ Confirm Receipt & Release Funds
                                    </button>
                                    <small class="form-text text-muted">
                                        Only confirm if you have received the order as described
                                    </small>
                                </form>
                                {% endif %}
                                
                                {% if can_dispute and not order.dispute %}
                                <a href="{% url 'orders:raise_dispute' order.id %}" class="btn btn-danger">
                                    ‚ö†Ô∏è Raise Dispute
                                </a>
                                {% endif %}
                            {% endif %}

                            <!-- Vendor Actions -->
                            {% if is_vendor %}
                                {% if can_ship %}
                                <form method="post" action="{% url 'orders:mark_shipped' order.id %}" class="action-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        üìÆ Mark as Shipped
                                    </button>
                                    <small class="form-text text-muted">
                                        Mark as shipped once you've sent the order
                                    </small>
                                </form>
                                {% endif %}
                                
                                {% if can_dispute and not order.dispute %}
                                <a href="{% url 'orders:raise_dispute' order.id %}" class="btn btn-danger">
                                    ‚ö†Ô∏è Raise Dispute
                                </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Back Button -->
                    <div class="mt-4 text-center">
                        <a href="{% url 'orders:list' %}" class="btn btn-secondary">
                            ‚Üê Back to Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.order-header {
    border-bottom: 2px solid rgba(139, 92, 246, 0.2);
    padding-bottom: 1rem;
}

.order-icon {
    font-size: 2rem;
    margin-right: 0.5rem;
}

.order-meta {
    display: flex;
    gap: 2rem;
    align-items: center;
    flex-wrap: wrap;
}

.order-id {
    color: #9ca3af;
}

.order-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.875rem;
}

.status-pending { background: #374151; color: #9ca3af; }
.status-paid { background: #1e40af; color: #60a5fa; }
.status-locked { background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; }
.status-processing { background: #f59e0b; color: #000; }
.status-shipped { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: #fff; }
.status-delivered { background: #059669; color: #fff; }
.status-completed { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
.status-disputed { background: #ef4444; color: #fff; }
.status-refunded { background: #6b7280; color: #fff; }

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.info-item label {
    color: #9ca3af;
    font-size: 0.875rem;
}

.info-item span {
    color: #f3f4f6;
    font-weight: 500;
}

.amount {
    color: #60a5fa;
    font-family: monospace;
}

.order-items {
    background: rgba(31, 41, 55, 0.5);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(75, 85, 99, 0.3);
}

.order-item:last-child {
    border-bottom: none;
}

.item-name {
    font-weight: 500;
    color: #e5e7eb;
}

.item-details {
    display: flex;
    gap: 1rem;
    color: #9ca3af;
    font-size: 0.875rem;
}

.status-timeline {
    background: rgba(31, 41, 55, 0.3);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(139, 92, 246, 0.1);
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 0.5rem;
    bottom: 0.5rem;
    width: 2px;
    background: rgba(139, 92, 246, 0.2);
}

.timeline-item {
    position: relative;
    padding: 0.5rem 0;
}

.timeline-marker {
    position: absolute;
    left: -1.5rem;
    top: 0.75rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #374151;
    border: 2px solid #1f2937;
}

.timeline-item.completed .timeline-marker {
    background: #8b5cf6;
    border-color: #8b5cf6;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

.timeline-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.timestamp {
    font-size: 0.75rem;
    color: #6b7280;
}

.order-actions {
    background: rgba(139, 92, 246, 0.05);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.actions-grid {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: start;
}

.action-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1rem;
}

@media (max-width: 768px) {
    .order-meta {
        flex-direction: column;
        gap: 1rem;
        align-items: start;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
