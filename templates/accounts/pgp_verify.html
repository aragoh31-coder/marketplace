{% extends "base_tor_safe.html" %}
{% block title %}Verify PGP Key{% endblock %}
{% block content %}
<div class="container">
    <div class="pgp-verify-container">
        <h1>üîê Verify Your PGP Key</h1>
        
        <div class="progress-steps">
            <div class="step completed">
                <span class="step-number">1</span>
                <span class="step-label">Upload Key</span>
            </div>
            <div class="step active">
                <span class="step-number">2</span>
                <span class="step-label">Verify Decryption</span>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <span class="step-label">Save Settings</span>
            </div>
        </div>
        
        <div class="info-box {% if error %}error{% endif %}">
            <h3>Verification Required</h3>
            <p>To ensure you have access to the private key, please:</p>
            <ol>
                <li>Copy the encrypted message below</li>
                <li>Decrypt it with your PGP private key</li>
                <li>Enter the verification code from the decrypted message</li>
            </ol>
            {% if error %}
            <p class="error-message">‚ùå Invalid code. Please try again.</p>
            {% endif %}
        </div>
        
        {% if key_info %}
        <div class="key-info">
            <h3>Key Information</h3>
            <table class="info-table">
                <tr>
                    <td>Fingerprint:</td>
                    <td><code>{{ fingerprint }}</code></td>
                </tr>
                {% if key_info.uids %}
                <tr>
                    <td>User ID:</td>
                    <td>{{ key_info.uids.0 }}</td>
                </tr>
                {% endif %}
                {% if key_info.algo %}
                <tr>
                    <td>Algorithm:</td>
                    <td>{{ key_info.algo }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}
        
        <div class="encrypted-section">
            <h2>Encrypted Verification Message</h2>
            <p class="help-text">Decrypt this message to find your verification code:</p>
            
            <div class="pgp-message-container">
                <textarea id="encrypted-message" class="pgp-textarea" readonly>{{ encrypted_message }}</textarea>
                <p class="help-text">üìã Select the text above and copy it manually (Ctrl+C or Cmd+C)</p>
            </div>
        </div>
        
        <form method="post" action="{% url 'accounts:pgp_settings' %}" class="verify-form">
            {% csrf_token %}
            <div class="code-section">
                <h2>Enter Verification Code</h2>
                <p class="help-text">After decrypting, enter only the verification code:</p>
                
                <input type="text" 
                       name="verify_code" 
                       class="verify-input" 
                       placeholder="Enter verification code"
                       autocomplete="off"
                       required
                       {% if error %}autofocus{% endif %}>
                
                <small class="form-hint">The code is a random string like: <code>AbCdEfGhIjKlMnOp</code></small>
            </div>
            
            <div class="button-group">
                <button type="submit" class="btn btn-primary">
                    ‚úÖ Verify & Save Key
                </button>
                <a href="{% url 'accounts:pgp_settings' %}" class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
        
        <div class="help-section">
            <details>
                <summary>üìö How to Decrypt</summary>
                <div class="help-content">
                    <h3>Command Line (GPG)</h3>
                    <pre>
# Save the message to a file
cat > verify.asc

# Decrypt it
gpg --decrypt verify.asc

# Look for "Verification Code: XXXXX" in the output</pre>
                    
                    <h3>Kleopatra (Windows)</h3>
                    <ol>
                        <li>Copy the encrypted message</li>
                        <li>Open Kleopatra</li>
                        <li>Click "Clipboard" ‚Üí "Decrypt/Verify"</li>
                        <li>Find the verification code in the decrypted text</li>
                    </ol>
                    
                    <h3>What you're looking for:</h3>
                    <div class="example-output">
                        <pre>PGP Key Verification

Please decrypt this message to verify your key.
Verification Code: <span class="highlight">AbCdEfGhIjKlMnOp</span>

Enter only the verification code above.</pre>
                    </div>
                </div>
            </details>
        </div>
        
        <div class="timeout-warning">
            <p>‚è±Ô∏è This verification expires in 10 minutes</p>
        </div>
    </div>
</div>

<style>
    .pgp-verify-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        padding: 0 20px;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
    }
    
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #333;
        z-index: -1;
    }
    
    .step.completed:not(:last-child)::after {
        background: #4CAF50;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        background: #333;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .step.completed .step-number {
        background: #4CAF50;
        color: #000;
    }
    
    .step.active .step-number {
        background: #ff9800;
        color: #000;
    }
    
    .step-label {
        font-size: 14px;
        color: #888;
    }
    
    .info-box {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .info-box.error {
        border-color: #f44336;
        background: rgba(244, 67, 54, 0.1);
    }
    
    .info-box h3 {
        margin-bottom: 15px;
        color: #4CAF50;
    }
    
    .info-box.error h3 {
        color: #f44336;
    }
    
    .info-box ol {
        margin-left: 20px;
        color: #ccc;
    }
    
    .info-box li {
        margin-bottom: 8px;
    }
    
    .error-message {
        margin-top: 15px;
        color: #f44336;
        font-weight: bold;
    }
    
    .key-info {
        background: #2a2a2a;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .info-table {
        width: 100%;
        margin-top: 10px;
    }
    
    .info-table td {
        padding: 8px 0;
        vertical-align: top;
    }
    
    .info-table td:first-child {
        width: 120px;
        color: #888;
    }
    
    .info-table code {
        color: #4CAF50;
        font-family: monospace;
        font-size: 14px;
    }
    
    .encrypted-section {
        margin-bottom: 30px;
    }
    
    .pgp-message-container {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 15px;
    }
    
    .pgp-textarea {
        width: 100%;
        min-height: 250px;
        background: transparent;
        border: none;
        color: #4CAF50;
        font-family: monospace;
        font-size: 12px;
        resize: vertical;
        margin-bottom: 10px;
    }
    
    .verify-form {
        margin-bottom: 30px;
    }
    
    .code-section {
        margin-bottom: 30px;
    }
    
    .verify-input {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        font-family: monospace;
        background: #2a2a2a;
        border: 2px solid #444;
        color: #fff;
        border-radius: 8px;
        text-align: center;
        letter-spacing: 2px;
    }
    
    .verify-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    .form-hint {
        display: block;
        margin-top: 10px;
        color: #888;
        text-align: center;
    }
    
    .form-hint code {
        color: #ff9800;
        font-size: 14px;
    }
    
    .example-output {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 15px;
        margin-top: 10px;
    }
    
    .example-output pre {
        color: #ccc;
        font-size: 13px;
        margin: 0;
    }
    
    .highlight {
        background: #ff9800;
        color: #000;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .timeout-warning {
        text-align: center;
        color: #ff9800;
        font-size: 14px;
        margin-top: 20px;
    }
    
    @media (max-width: 768px) {
        .progress-steps {
            padding: 0;
        }
        
        .step-label {
            font-size: 12px;
        }
        
        .pgp-textarea {
            font-size: 11px;
            min-height: 200px;
        }
        
        .verify-input {
            font-size: 16px;
        }
    }
</style>
{% endblock %}
