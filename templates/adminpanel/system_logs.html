{% extends 'base_tor_safe.html' %}
{% load static %}

{% block title %}System Logs{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-list-alt"></i> System Logs</h4>
                    <p class="mb-0 text-muted">Monitor system activity and security events</p>
                </div>
                <div class="card-body">
                    <!-- Filter Controls -->
                    <form method="get" class="mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="action_filter">Action Type:</label>
                                <select name="action" id="action_filter" class="form-control">
                                    <option value="">All Actions</option>
                                    <option value="login" {% if request.GET.action == 'login' %}selected{% endif %}>Login</option>
                                    <option value="withdrawal_request" {% if request.GET.action == 'withdrawal_request' %}selected{% endif %}>Withdrawal Request</option>
                                    <option value="admin_action" {% if request.GET.action == 'admin_action' %}selected{% endif %}>Admin Action</option>
                                    <option value="security_alert" {% if request.GET.action == 'security_alert' %}selected{% endif %}>Security Alert</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="risk_filter">Risk Level:</label>
                                <select name="risk" id="risk_filter" class="form-control">
                                    <option value="">All Risk Levels</option>
                                    <option value="high" {% if request.GET.risk == 'high' %}selected{% endif %}>High (50+)</option>
                                    <option value="medium" {% if request.GET.risk == 'medium' %}selected{% endif %}>Medium (25-49)</option>
                                    <option value="low" {% if request.GET.risk == 'low' %}selected{% endif %}>Low (0-24)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="flagged_filter">Flagged Only:</label>
                                <select name="flagged" id="flagged_filter" class="form-control">
                                    <option value="">All Events</option>
                                    <option value="true" {% if request.GET.flagged == 'true' %}selected{% endif %}>Flagged Only</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary form-control">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Logs Table -->
                    {% if logs %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Details</th>
                                        <th>Risk Score</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in logs %}
                                        <tr {% if log.flagged %}class="table-warning"{% endif %}>
                                            <td>
                                                <small>{{ log.created_at|date:"M d, Y H:i:s" }}</small>
                                            </td>
                                            <td>
                                                <strong>{{ log.user.username }}</strong>
                                                {% if log.user.is_staff %}
                                                    <span class="badge badge-info">Staff</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if log.action == 'login' %}
                                                    <i class="fas fa-sign-in-alt text-success"></i> Login
                                                {% elif log.action == 'withdrawal_request' %}
                                                    <i class="fas fa-money-bill-wave text-warning"></i> Withdrawal
                                                {% elif log.action == 'admin_action' %}
                                                    <i class="fas fa-user-shield text-info"></i> Admin Action
                                                {% elif log.action == 'security_alert' %}
                                                    <i class="fas fa-exclamation-triangle text-danger"></i> Security Alert
                                                {% else %}
                                                    <i class="fas fa-info-circle"></i> {{ log.get_action_display }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if log.details %}
                                                    {% for key, value in log.details.items %}
                                                        <small><strong>{{ key|title }}:</strong> {{ value }}</small><br>
                                                    {% endfor %}
                                                {% else %}
                                                    <small class="text-muted">No additional details</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if log.risk_score >= 50 %}
                                                    <span class="badge badge-danger">{{ log.risk_score }}</span>
                                                {% elif log.risk_score >= 25 %}
                                                    <span class="badge badge-warning">{{ log.risk_score }}</span>
                                                {% else %}
                                                    <span class="badge badge-success">{{ log.risk_score }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if log.flagged %}
                                                    <span class="badge badge-warning">
                                                        <i class="fas fa-flag"></i> Flagged
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check"></i> Normal
                                                    </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if is_paginated %}
                            <nav aria-label="Log pagination">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if request.GET.action %}&action={{ request.GET.action }}{% endif %}{% if request.GET.risk %}&risk={{ request.GET.risk }}{% endif %}{% if request.GET.flagged %}&flagged={{ request.GET.flagged }}{% endif %}">First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.action %}&action={{ request.GET.action }}{% endif %}{% if request.GET.risk %}&risk={{ request.GET.risk }}{% endif %}{% if request.GET.flagged %}&flagged={{ request.GET.flagged }}{% endif %}">Previous</a>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active">
                                        <span class="page-link">
                                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.action %}&action={{ request.GET.action }}{% endif %}{% if request.GET.risk %}&risk={{ request.GET.risk }}{% endif %}{% if request.GET.flagged %}&flagged={{ request.GET.flagged }}{% endif %}">Next</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.action %}&action={{ request.GET.action }}{% endif %}{% if request.GET.risk %}&risk={{ request.GET.risk }}{% endif %}{% if request.GET.flagged %}&flagged={{ request.GET.flagged }}{% endif %}">Last</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No logs found</h5>
                            <p class="text-muted">No system logs match your current filters.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.table-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.badge {
    font-size: 0.75em;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9em;
}

.table td {
    font-size: 0.85em;
    vertical-align: middle;
}

.pagination .page-link {
    color: #667eea;
}

.pagination .page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
}
</style>
{% endblock %}
