{% extends "base_tor_safe.html" %}

{% block title %}Admin Authentication - Secure Marketplace{% endblock %}

{% block extra_head %}
<style>
    .auth-container {
        max-width: 500px;
        margin: 50px auto;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    .auth-step {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #007bff;
    }
    .auth-step.completed {
        border-left-color: #28a745;
        background: #f8fff9;
    }
    .auth-step.current {
        border-left-color: #ffc107;
        background: #fffef8;
    }
    .step-indicator {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
        margin-right: 10px;
        font-weight: bold;
    }
    .step-completed { background: #28a745; color: white; }
    .step-current { background: #ffc107; color: black; }
    .step-pending { background: #6c757d; color: white; }
    .pgp-challenge {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
        margin: 10px 0;
    }
    .security-notice {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <h1>üîê Admin Authentication</h1>
    
    <div class="security-notice">
        <h3>Triple Authentication Required</h3>
        <p>Admin access requires three levels of authentication for maximum security:</p>
        <ol>
            <li>Primary admin password</li>
            <li>Secondary authentication password</li>
            <li>PGP signature verification</li>
        </ol>
    </div>
    
    <!-- Step 1: Primary Password -->
    <div class="auth-step {% if step >= 1 %}completed{% elif current_step == 1 %}current{% endif %}">
        <span class="step-indicator {% if step >= 1 %}step-completed{% elif current_step == 1 %}step-current{% else %}step-pending{% endif %}">1</span>
        <strong>Primary Password</strong>
        {% if step >= 1 %}
            <span class="text-success">‚úì Verified</span>
        {% elif current_step == 1 %}
            <form method="post" action="{% url 'adminpanel:login' %}">
                {% csrf_token %}
                <div class="form-group mt-3">
                    <label for="password">Admin Password:</label>
                    <input type="password" id="password" name="password" class="form-control" required autocomplete="current-password">
                </div>
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                <button type="submit" class="btn btn-primary mt-2">Verify Password</button>
                <input type="hidden" name="step" value="1">
            </form>
        {% endif %}
    </div>
    
    <!-- Step 2: Secondary Authentication -->
    <div class="auth-step {% if step >= 2 %}completed{% elif current_step == 2 %}current{% endif %}">
        <span class="step-indicator {% if step >= 2 %}step-completed{% elif current_step == 2 %}step-current{% else %}step-pending{% endif %}">2</span>
        <strong>Secondary Authentication</strong>
        {% if step >= 2 %}
            <span class="text-success">‚úì Verified</span>
        {% elif current_step == 2 %}
            <form method="post" action="{% url 'adminpanel:secondary_auth' %}">
                {% csrf_token %}
                <div class="form-group mt-3">
                    <label for="secondary_password">Secondary Password:</label>
                    <input type="password" id="secondary_password" name="secondary_password" class="form-control" required autocomplete="off">
                </div>
                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                <button type="submit" class="btn btn-primary mt-2">Verify Secondary</button>
            </form>
        {% endif %}
    </div>
    
    <!-- Step 3: PGP Verification -->
    <div class="auth-step {% if step >= 3 %}completed{% elif current_step == 3 %}current{% endif %}">
        <span class="step-indicator {% if step >= 3 %}step-completed{% elif current_step == 3 %}step-current{% else %}step-pending{% endif %}">3</span>
        <strong>PGP Signature Verification</strong>
        {% if step >= 3 %}
            <span class="text-success">‚úì Verified</span>
        {% elif current_step == 3 %}
            <div class="mt-3">
                <p>Please sign the following challenge with your admin PGP key:</p>
                <div class="pgp-challenge">{{ pgp_challenge }}</div>
                
                <form method="post" action="{% url 'adminpanel:pgp_verify' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="pgp_signature">PGP Signature:</label>
                        <textarea id="pgp_signature" name="pgp_signature" class="form-control" rows="10" required placeholder="-----BEGIN PGP SIGNATURE-----
...
-----END PGP SIGNATURE-----"></textarea>
                    </div>
                    {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary mt-2">Verify Signature</button>
                    <input type="hidden" name="challenge_id" value="{{ challenge_id }}">
                </form>
            </div>
        {% endif %}
    </div>
    
    {% if step >= 3 %}
    <div class="text-center mt-4">
        <a href="{% url 'adminpanel:dashboard' %}" class="btn btn-success btn-lg">
            üöÄ Access Admin Panel
        </a>
    </div>
    {% endif %}
    
    <div class="security-notice mt-4">
        <h3>üõ°Ô∏è Security Features</h3>
        <ul>
            <li>All authentication attempts are logged</li>
            <li>Failed attempts result in temporary lockout</li>
            <li>PGP challenges expire after 5 minutes</li>
            <li>Sessions timeout after 30 minutes of inactivity</li>
            <li>No JavaScript required - Tor compatible</li>
        </ul>
    </div>
</div>

{% endblock %}
